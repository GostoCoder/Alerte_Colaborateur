{% extends "base.html" %}

{% block title %}Gestion des Véhicules - Base de données 2{% endblock %}

{% block content %}
<div class="container-xl mt-4">
    <div class="card">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col">
                    <h1>Liste des Véhicules</h1>
                </div>
                <div class="col text-end">
                    <a href="{{ url_for('add_collaborateur_2') }}" class="btn btn-primary">Ajouter un collaborateur</a>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="GET" action="{{ url_for('index_2') }}" class="mb-4">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" 
                           placeholder="Rechercher par type, marque, plaque, travaille avec, kilométrage, etc..." 
                           value="{{ request.args.get('search', '') }}">
                    <button type="submit" class="btn btn-primary">Rechercher</button>
                </div>
            </form>


            <div class="table-responsive">
                <table id="collab-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Actions</th>
<th class="sortable">Nom</th>
<th class="sortable">Prénom</th>
<th class="sortable">Date de Renouvellement</th>
<th class="sortable">Date de Validité</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for collaborateur in collaborateurs %}
                        <tr>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('edit_collaborateur_2', id=collaborateur.id) }}" class="btn btn-sm btn-warning rounded-circle d-flex align-items-center justify-content-center" style="width:28px;height:28px;padding:0;" title="Modifier">
                                        <i class="fas fa-pen"></i>
                                    </a>
                                    <button type="button" onclick='confirmDelete({{ collaborateur.id }})'
        class="btn btn-sm btn-danger rounded-circle d-flex align-items-center justify-content-center"
        style="width:28px;height:28px;padding:0;" title="Supprimer">
    <i class="fas fa-trash"></i>
</button>
                                </div>
                            </td>
                            <td>{{ collaborateur.nom }}</td>
                            <td>{{ collaborateur.prenom }}</td>
                            <td>{{ collaborateur.date_renouvellement.strftime('%d/%m/%Y') if collaborateur.date_renouvellement }}</td>
                            <td>{{ collaborateur.date_validite.strftime('%d/%m/%Y') if collaborateur.date_validite }}</td>
                            <td>{{ collaborateur.commentaire }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce collaborateur ?')) {
        window.location.href = "/delete_collaborateur_route_2/" + id;
    }
}
</script>
<script>
// Simple table sorter for the collaborators table (copied from index_1.html, adjusted for compatibility)
document.addEventListener('DOMContentLoaded', function () {
  var table = document.getElementById('collab-table');
  if (!table) return;
  var tbody = table.querySelector('tbody');
  var headers = table.querySelectorAll('thead th');
  headers.forEach(function(th, idx) {
    // Skip non-sortable columns (Actions)
    if (th.textContent.trim() === 'Actions') return;
    th.style.cursor = 'pointer';
    th.dataset.sortDir = 'none';
    th.addEventListener('click', function() {
      // Toggle direction
      var dir = th.dataset.sortDir === 'asc' ? 'desc' : 'asc';
      headers.forEach(function(h) {
        if (h !== th) {
          h.dataset.sortDir = 'none';
          var ex = h.querySelector('.sort-indicator');
          if (ex) ex.remove();
        } else {
          var ex2 = h.querySelector('.sort-indicator');
          if (ex2) ex2.remove();
        }
      });
      th.dataset.sortDir = dir;

      // Get rows as array
      var rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort(function(a, b) {
        var aCell = a.children[idx] && a.children[idx].textContent ? a.children[idx].textContent.trim() : '';
        var bCell = b.children[idx] && b.children[idx].textContent ? b.children[idx].textContent.trim() : '';

        // Try numeric
        var aNum = parseFloat(aCell.replace(',', '.'));
        var bNum = parseFloat(bCell.replace(',', '.'));
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return dir === 'asc' ? aNum - bNum : bNum - aNum;
        }

        // Try date (dd/mm/yyyy)
        var parseDate = function(s) {
          var parts = s.split('/');
          return parts.length === 3 ? new Date(parts[2], parts[1]-1, parts[0]).getTime() : NaN;
        };
        var aTime = parseDate(aCell);
        var bTime = parseDate(bCell);
        if (!isNaN(aTime) && !isNaN(bTime)) {
          return dir === 'asc' ? aTime - bTime : bTime - aTime;
        }

        // Fallback string compare (localeCompare)
        return dir === 'asc' ? aCell.localeCompare(bCell, undefined, {numeric:true, sensitivity:'base'}) : bCell.localeCompare(aCell, undefined, {numeric:true, sensitivity:'base'});
      });

      // Reattach rows
      rows.forEach(function(r) { tbody.appendChild(r); });

      // Add indicator (same UI as index_1)
      var indicator = document.createElement('span');
      indicator.className = 'sort-indicator';
      indicator.textContent = dir === 'asc' ? ' ▲' : ' ▼';
      th.appendChild(indicator);
    });
  });
});
</script>
{% endblock %}
