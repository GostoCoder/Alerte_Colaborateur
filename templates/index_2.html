{% extends "base.html" %}

{% block title %}Gestion des Véhicules - Base de données 2{% endblock %}

{% block content %}
<div class="container-xl mt-4">
    <div class="card">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col">
                    <h1>Liste des Véhicules</h1>
                </div>
                <div class="col text-end">
                    <a href="{{ url_for('add_collaborateur_2') }}" class="btn btn-primary">Ajouter un collaborateur</a>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="GET" action="{{ url_for('index_2') }}" class="mb-4">
                <div class="input-group">
                    <input type="text" name="search" class="form-control" 
                           placeholder="Rechercher par type, marque, plaque, travaille avec, kilométrage, etc..." 
                           value="{{ request.args.get('search', '') }}">
                    <button type="submit" class="btn btn-primary">Rechercher</button>
                </div>
            </form>

            <style>
                .sortable {
                    cursor: pointer;
                    position: relative;
                    padding-right: 20px !important;
                }
                .sortable:after {
                    content: '↕';
                    position: absolute;
                    right: 5px;
                    color: #999;
                }
                .sortable.asc:after {
                    content: '↑';
                    color: #000;
                }
                .sortable.desc:after {
                    content: '↓';
                    color: #000;
                }
            </style>

            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Actions</th>
<th class="sortable {{ 'asc' if sort_by == 'nom' and sort_order == 'asc' else 'desc' if sort_by == 'nom' else '' }}" data-col-index="1" data-type="text">
    <a href="{{ url_for('index_2', sort_by='nom', sort_order='desc' if sort_by=='nom' and sort_order=='asc' else 'asc', search=search_term) }}" style="text-decoration:none;color:inherit;">Nom</a>
</th>
<th class="sortable {{ 'asc' if sort_by == 'prenom' and sort_order == 'asc' else 'desc' if sort_by == 'prenom' else '' }}" data-col-index="2" data-type="text">
    <a href="{{ url_for('index_2', sort_by='prenom', sort_order='desc' if sort_by=='prenom' and sort_order=='asc' else 'asc', search=search_term) }}" style="text-decoration:none;color:inherit;">Prénom</a>
</th>
<th class="sortable {{ 'asc' if sort_by == 'date_renouvellement' and sort_order == 'asc' else 'desc' if sort_by == 'date_renouvellement' else '' }}" data-col-index="3" data-type="date">
    <a href="{{ url_for('index_2', sort_by='date_renouvellement', sort_order='desc' if sort_by=='date_renouvellement' and sort_order=='asc' else 'asc', search=search_term) }}" style="text-decoration:none;color:inherit;">Date de Renouvellement</a>
</th>
<th class="sortable {{ 'asc' if sort_by == 'date_validite' and sort_order == 'asc' else 'desc' if sort_by == 'date_validite' else '' }}" data-col-index="4" data-type="date">
    <a href="{{ url_for('index_2', sort_by='date_validite', sort_order='desc' if sort_by=='date_validite' and sort_order=='asc' else 'asc', search=search_term) }}" style="text-decoration:none;color:inherit;">Date de Validité</a>
</th>
                            <th>Commentaire</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for collaborateur in collaborateurs %}
                        <tr>
                            <td>
                                <div class="btn-group">
                                    <a href="{{ url_for('edit_collaborateur_2', id=collaborateur.id) }}" class="btn btn-sm btn-warning rounded-circle d-flex align-items-center justify-content-center" style="width:28px;height:28px;padding:0;" title="Modifier">
                                        <i class="fas fa-pen"></i>
                                    </a>
                                    <button type="button" onclick='confirmDelete({{ collaborateur.id }})'
        class="btn btn-sm btn-danger rounded-circle d-flex align-items-center justify-content-center"
        style="width:28px;height:28px;padding:0;" title="Supprimer">
    <i class="fas fa-trash"></i>
</button>
                                </div>
                            </td>
                            <td>{{ collaborateur.nom }}</td>
                            <td>{{ collaborateur.prenom }}</td>
                            <td>{{ collaborateur.date_renouvellement.strftime('%d/%m/%Y') if collaborateur.date_renouvellement }}</td>
                            <td>{{ collaborateur.date_validite.strftime('%d/%m/%Y') if collaborateur.date_validite }}</td>
                            <td>{{ collaborateur.commentaire }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function confirmDelete(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce collaborateur ?')) {
        window.location.href = "/delete_collaborateur_route_2/" + id;
    }
}

// Table sorting logic
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sortable a').forEach(function(anchor) {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            var th = anchor.closest('th');
            var table = th.closest('table');
            var tbody = table.querySelector('tbody');
            var colIndex = parseInt(th.getAttribute('data-col-index'));
            var type = th.getAttribute('data-type');
            var rows = Array.from(tbody.querySelectorAll('tr'));
            var asc = !th.classList.contains('asc');
            rows.sort(function(a, b) {
                var getCell = function(row) {
                    var cell = row.children[colIndex];
                    return cell ? cell.textContent.trim() : '';
                };
                var valA = getCell(a), valB = getCell(b);
                if(type === 'date') {
                    var parseDate = function(s) {
                        var parts = s.split('/');
                        return parts.length === 3 ? new Date(parts[2], parts[1]-1, parts[0]).getTime() : 0;
                    };
                    valA = parseDate(valA) || 0;
                    valB = parseDate(valB) || 0;
                } else if(type === 'number') {
                    valA = parseFloat(valA.replace(/[^\d.-]/g, '')) || 0;
                    valB = parseFloat(valB.replace(/[^\d.-]/g, '')) || 0;
                } else {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }
                if(valA < valB) return asc ? -1 : 1;
                if(valA > valB) return asc ? 1 : -1;
                return 0;
            });
            // Remove asc/desc from all sortable th
            th.parentElement.querySelectorAll('.sortable').forEach(function(th2) {
                th2.classList.remove('asc', 'desc');
            });
            th.classList.toggle('asc', asc);
            th.classList.toggle('desc', !asc);
            rows.forEach(function(row) { tbody.appendChild(row); });
        });
    });
});
</script>
{% endblock %}
